<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-color: #f8f9fa;
            --content-background-color: #ffffff;
            --primary-color: #4f46e5;
            --primary-color-hover: #4338ca;
            --danger-color: #ef4444;
            --danger-color-hover: #dc2626;
            --success-color: #22c55e;
            --border-color: #e5e7eb;
            --text-color-primary: #1f2937;
            --text-color-secondary: #6b7280;
            --input-background-color: #f9fafb;
            --sidebar-width: 260px;
            
            /* --- NEW: Variables for Modal Styling from User Page --- */
            --modal-background-color: var(--content-background-color);
            --modal-text-color: var(--text-color-primary);
            --modal-close-btn-background: #ffffff;
            --modal-close-btn-color: #1f2937;
            --modal-close-btn-hover-background: #f3f4f6;
            --modal-close-btn-hover-color: #1f2937;
            --button-secondary-hover-color: #e5e7eb;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color-primary);
            padding: 1rem;
        }
        
        /* Prevent background scroll when modal is open */
        html.modal-open, body.modal-open { 
            overflow: hidden; 
        }

        /* --- LAYOUT & SECTIONS --- */
        .container {
            max-width: 1400px;
            margin: 1rem auto;
        }
        
        main > header {
            margin-bottom: 2rem;
        }

        h1 {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: clamp(1.5rem, 4vw, 2rem);
            font-weight: 700;
            color: var(--text-color-primary);
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        h2 { font-size: clamp(1.25rem, 3vw, 1.5rem); font-weight: 600; margin-bottom: 1rem; }
        h3 { font-size: 1.125rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; }
        h4 { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }

        .brand-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--primary-color);
            flex-shrink: 0;
        }

        section {
            background: var(--content-background-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
        }
        
        /* --- BUTTONS --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-decoration: none;
            font-size: 0.875rem;
        }
        .btn svg { width: 16px; height: 16px; }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.07), 0 3px 6px rgba(0,0,0,0.05);
        }
        .btn:disabled {
            background-color: #e5e7eb;
            cursor: not-allowed;
            border-color: #e5e7eb;
            color: #9ca3af;
        }

        .btn-primary { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-color-hover); border-color: var(--primary-color-hover); }
        
        .btn-danger { background-color: var(--danger-color); color: #fff; border-color: var(--danger-color); }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-color-hover); border-color: var(--danger-color-hover); }

        .btn-secondary {
            background-color: #fff;
            color: var(--text-color-primary);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover:not(:disabled) { background-color: #f9fafb; border-color: #d1d5db; }

        /* --- TABLES --- */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        th, td {
            text-align: left;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            vertical-align: middle;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: var(--text-color-secondary);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:nth-child(even) { background-color: #f9fafb; }

        .status-active { color: var(--success-color); font-weight: 600; }
        .status-suspended, .status-blocked, .status-bot_blocked { color: var(--danger-color); font-weight: 600; }
        .status-pending { color: #f59e0b; font-weight: 600; }

        /* --- FORMS --- */
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color-primary); font-size: 0.875rem; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--input-background-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        .form-group textarea { min-height: 120px; resize: vertical; }

        .form-grid {
            display: grid;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .form-grid-2 { grid-template-columns: repeat(2, 1fr); }
            .form-grid-3 { grid-template-columns: repeat(3, 1fr); }
        }

        /* --- MODALS (dialog) - UPDATED STYLES --- */
        dialog {
            background-color: var(--modal-background-color);
            color: var(--modal-text-color);
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            border: none;
            padding: 0;
            animation: fadeIn 200ms ease-in-out;
            position: relative; 
            margin: auto;
            width: min(92vw, 900px);
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: scale(0.95); } 
            to { opacity: 1; transform: scale(1); } 
        }
        
        dialog::backdrop {
            background-color: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-header, .modal-body, .modal-footer {
            background-color: transparent;
            color: inherit;
        }
        
        .modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }
        
        .close-button, .modal-close-btn {
            background: var(--modal-close-btn-background); 
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            color: var(--modal-close-btn-color);
            font-size: 1.5rem;
            line-height: 1;
            transition: all 0.2s;
            flex-shrink: 0;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-button:hover, .modal-close-btn:hover {
            background: var(--modal-close-btn-hover-background);
            color: var(--modal-close-btn-hover-color);
        }
        
        .modal-body { 
            padding: 32px; 
            max-height: 75vh; 
            overflow-y: auto; 
        }
        
        .modal-footer {
            padding: 24px 32px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background-color: transparent;
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
        }
        
        /* --- SPECIFIC COMPONENTS --- */
        .danger-zone {
            border: 1px solid var(--danger-color);
            padding: 1.5rem;
            margin-top: 1.5rem;
            border-radius: 12px;
            background-color: #fef2f2;
        }
        .danger-zone h4 { color: #991b1b; }

        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 1rem; }

        #data-viewer-content img, #data-viewer-content video { max-width: 100%; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color); }
        #data-viewer-content .data-grid { display: grid; grid-template-columns: auto 1fr; gap: 8px 16px; align-items: center; }
        #data-viewer-content .data-grid strong { font-weight: 500; color: var(--text-color-secondary); }

        /* --- SPECIFIC INPUT ENHANCEMENTS --- */
        #delete-added-id {
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--input-background-color);
            transition: border-color 0.2s, box-shadow 0.2s;
            min-width: 220px;
        }
        #delete-added-id:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* --- GLOBAL LOADER --- */
        #global-loader {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background-color: #fff; padding: 12px 24px; border-radius: 50px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.07);
            display: none; align-items: center; gap: 12px; z-index: 99999;
            pointer-events: none;
        }
        .loader-spinner {
            width: 20px; height: 20px; border: 2px solid var(--primary-color);
            border-top-color: transparent; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- RESPONSIVE DESIGN --- */
        @media (max-width: 768px) {
            body { padding: 0.5rem; }
            .container { margin: 0.5rem; }
            section { padding: 1rem; }
            
            .modal-header, .modal-body, .modal-footer {
                padding: 16px 20px;
            }

            .actions-cell { min-width: 150px; } /* Prevent action buttons from wrapping too soon */
            
            .form-grid, .form-grid-2, .form-grid-3 { grid-template-columns: 1fr; }
            
            #news-form {
                display: flex;
                flex-direction: column;
            }

            /* Make data tables more readable on small screens */
            table { font-size: 0.8rem; }
            th, td { white-space: normal; padding: 10px 12px; }

            /* Stack the action row in the news form */
            #news-form > div:last-child {
                display: flex !important;
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 0.75rem !important;
            }
            #news-form > div:last-child .btn { width: 100%; }
            #news-form > div:last-child input#delete-added-id { width: 100%; min-width: 0; }
        }
    </style>
</head>
<body>
    <div id="global-loader">
        <div class="loader-spinner"></div>
        <span id="loader-message">–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è...</span>
    </div>

    <main class="container">
        <header>
            <h1><span class="brand-dot"></span> –ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è</h1>
        </header>
        <div id="prompt-container"><p>–í–≤–µ–¥—ñ—Ç—å –∫–ª—é—á –¥–æ—Å—Ç—É–ø—É –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö.</p></div>
        <div id="admin-content" style="display:none;"></div>
    </main>

    <dialog id="user-details-modal">
        <div class="modal-header">
            <h2 id="modal-title">–î–µ—Ç–∞–ª—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h2>
            <button class="close-button" onclick="document.getElementById('user-details-modal').close()">&times;</button>
        </div>
        <div class="modal-body" id="modal-body-content"></div>
    </dialog>

    <dialog id="page-editor-admin-modal">
        <div class="modal-header">
            <h2>–†–µ–¥–∞–∫—Ç–æ—Ä —Å—Ç–æ—Ä—ñ–Ω–∫–∏</h2>
            <button class="close-button" onclick="document.getElementById('page-editor-admin-modal').close()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-grid form-grid-2">
                <div class="form-group">
                    <label for="editor-source">–î–∂–µ—Ä–µ–ª–æ</label>
                    <select id="editor-source">
                        <option value="template">–®–∞–±–ª–æ–Ω</option>
                        <option value="custom">–°–≤—ñ–π HTML</option>
                    </select>
                </div>
                <div class="form-group" id="editor-template-group">
                    <label for="editor-template">–í–∏–±–µ—Ä—ñ—Ç—å —à–∞–±–ª–æ–Ω</label>
                    <select id="editor-template"></select>
                </div>
            </div>
            <div class="form-group" id="editor-html-group" style="display:none;">
                <label for="editor-html">HTML-–∫–æ–¥</label>
                <textarea id="editor-html" placeholder="<!DOCTYPE html>..."></textarea>
            </div>
            <div class="form-group">
                <label>–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</label>
                <iframe id="editor-preview" style="width:100%; height:300px; border:1px solid var(--border-color); border-radius:8px; background:white;"></iframe>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="document.getElementById('page-editor-admin-modal').close()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            <button id="page-editor-save-btn" class="btn btn-primary" onclick="saveAdminPageEditor()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </div>
    </dialog>

    <dialog id="data-viewer-modal">
        <div class="modal-header">
            <h2 id="data-viewer-title">–ü–µ—Ä–µ–≥–ª—è–¥ –¥–∞–Ω–∏—Ö</h2>
            <button class="close-button" onclick="document.getElementById('data-viewer-modal').close()">&times;</button>
        </div>
        <div class="modal-body" id="data-viewer-content"></div>
    </dialog>

    <script>
        const promptContainer = document.getElementById('prompt-container');
        const adminContent = document.getElementById('admin-content');
        const globalLoader = document.getElementById('global-loader');
        const loaderMessage = document.getElementById('loader-message');
        let ADMIN_SECRET_KEY = sessionStorage.getItem('admin_key');
        let dashboardData = {};
        let selectedUserIds = new Set();

        document.addEventListener('DOMContentLoaded', initializePanel);

        function showLoader(message = '–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è...') {
            loaderMessage.textContent = message;
            globalLoader.style.display = 'flex';
        }
        function hideLoader() {
            globalLoader.style.display = 'none';
        }

        // --- UPDATED Modal helpers ---
        function openModal(modalElement) {
            if (modalElement && typeof modalElement.showModal === 'function') {
                window.scrollTo({ top: 0, behavior: 'auto' });
                setTimeout(() => {
                    modalElement.showModal();
                    document.documentElement.classList.add('modal-open');
                    document.body.classList.add('modal-open');
                }, 50);
            }
        }

        // Setup listeners for all modals to manage body class
        document.querySelectorAll('dialog').forEach(modal => {
            modal.addEventListener('close', () => {
                const anyModalOpen = !!document.querySelector('dialog[open]');
                if (!anyModalOpen) {
                    document.documentElement.classList.remove('modal-open');
                    document.body.classList.remove('modal-open');
                }
            });
        });
        
        function setModalLoading(dialogId, message){
            const modal = document.getElementById(dialogId);
            const body = modal?.querySelector('.modal-body');
            if (body) {
                body.innerHTML = `
                    <div style="display:flex; align-items:center; justify-content:center; gap:12px; padding:2rem;">
                        <div class="loader-spinner"></div>
                        <span>${message || '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...'}</span>
                    </div>
                `;
            }
        }

        async function initializePanel() {
            if (!ADMIN_SECRET_KEY) {
                ADMIN_SECRET_KEY = prompt('–í–≤–µ–¥—ñ—Ç—å –∫–ª—é—á –¥–æ—Å—Ç—É–ø—É –¥–æ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ:');
                if (!ADMIN_SECRET_KEY) {
                    promptContainer.innerHTML = '<h1>–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ</h1><p>–ö–ª—é—á –Ω–µ –±—É–ª–æ –≤–≤–µ–¥–µ–Ω–æ.</p>';
                    return;
                }
                sessionStorage.setItem('admin_key', ADMIN_SECRET_KEY);
            }
            promptContainer.innerHTML = '<p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</p>';
            const success = await loadAndRenderDashboard();
            if (success) {
                promptContainer.style.display = 'none';
                adminContent.style.display = 'block';
            }
        }
        
        async function apiCall(action, payload = {}) {
            try {
                function base64EncodeUnicode(str) { return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1))); }
                const encodedKey = base64EncodeUnicode(ADMIN_SECRET_KEY);
                const res = await fetch('/.netlify/functions/admin-api', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${encodedKey}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, payload })
                });
                if (res.status === 401) {
                    sessionStorage.removeItem('admin_key');
                    promptContainer.innerHTML = '<h1>–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó</h1><p>–ö–ª—é—á –¥–æ—Å—Ç—É–ø—É –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –û–Ω–æ–≤—ñ—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É —ñ —Å–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.</p>';
                    promptContainer.style.display = 'block'; adminContent.style.display = 'none';
                    return null;
                }
                if (!res.ok) {
                    const errorText = await res.text();
                    alert(`–ü–æ–º–∏–ª–∫–∞ API: ${errorText}`);
                    return null;
                }
                return res;
            } catch (err) {
                alert(`–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ: ${err.message}`);
                return null;
            }
        }

        async function loadAndRenderDashboard() {
            showLoader('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∞–Ω–µ–ª—ñ...');
            try {
                const res = await apiCall('getDashboardData');
                if (!res) return false;
                dashboardData = await res.json();
                
                adminContent.innerHTML = `
                    <section>
                        <h2>–ì–ª–æ–±–∞–ª—å–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
                        <div class="form-group">
                            <label for="default-device-limit">–õ—ñ–º—ñ—Ç –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="number" id="default-device-limit" value="${dashboardData.settings.defaultDeviceLimit || 3}" style="max-width: 150px;">
                                <button class="btn btn-primary" onclick="updateGlobalSettings()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                            </div>
                        </div>
                    </section>
                    <section>
                        <h2>–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è-–∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è</h2>
                        <form id="generate-form" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <label for="uses" style="margin-bottom:0;">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤:</label>
                            <input type="number" id="uses" value="1" min="1" required style="width: 80px;">
                            <button type="submit" class="btn btn-primary">–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏</button>
                        </form>
                        <div id="new-link-container" style="margin-top: 1em;"></div>
                    </section>
                    <section>
                        <h2>–ù–æ–≤–∏–Ω–∏</h2>
                        <form id="news-form" class="form-grid form-grid-2">
                            <div class="form-group"><input type="text" id="news-title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" required></div>
                            <div class="form-group"><input type="url" id="news-image" placeholder="URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)"></div>
                            <div class="form-group" style="grid-column: 1 / -1;"><textarea id="news-text" placeholder="–¢–µ–∫—Å—Ç –Ω–æ–≤–∏–Ω–∏"></textarea></div>
                            <div style="grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                                <button type="submit" class="btn btn-primary">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ –Ω–æ–≤–∏–Ω—É</button>
                                <div style="display:flex; gap:8px; align-items:center; flex-wrap: wrap;">
                                    <input id="delete-added-id" placeholder="ID addedData –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è" style="flex:1;">
                                    <button type="button" class="btn btn-danger" onclick="deleteAddedBlock()">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                                    <button type="button" class="btn btn-danger" onclick="deleteAllAddedData()">–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
                                </div>
                            </div>
                        </form>
                        <div id="news-list" style="margin-top: 1.5rem;"></div>
                    </section>
                    <section>
                        <h2>–ê–∫—Ç–∏–≤–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è-–∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è</h2>
                        <div id="codes-table-wrapper" class="table-wrapper"></div>
                    </section>
                    <section>
                        <h2>–ö–µ—Ä—É–≤–∞–Ω–Ω—è —à–∞–±–ª–æ–Ω–∞–º–∏ —Å—Ç–æ—Ä—ñ–Ω–æ–∫</h2>
                         <form id="add-template-form">
                            <div class="form-group">
                                <label for="template-name">–ù–∞–∑–≤–∞ —à–∞–±–ª–æ–Ω—É</label> <input type="text" id="template-name" required>
                            </div>
                            <div class="form-group">
                                <label for="template-html">HTML-–∫–æ–¥ —à–∞–±–ª–æ–Ω—É</label> <textarea id="template-html" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">–î–æ–¥–∞—Ç–∏ —à–∞–±–ª–æ–Ω</button>
                        </form>
                        <h3>–Ü—Å–Ω—É—é—á—ñ —à–∞–±–ª–æ–Ω–∏</h3>
                        <div id="templates-table-wrapper" class="table-wrapper"></div>
                    </section>
                    <section>
                        <h2>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ (<span id="users-count">0</span>)</h2>
                        <div style="margin-bottom: 1rem; display:flex; flex-direction: column; gap:1rem;">
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn btn-secondary" onclick="selectAllUsers(true)">–í–∏–±—Ä–∞—Ç–∏ –≤—Å—ñ—Ö</button>
                                <button class="btn btn-secondary" onclick="selectAllUsers(false)">–°–∫–∏–Ω—É—Ç–∏ –≤–∏–±—ñ—Ä</button>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; align-items: flex-end;">
                                <div class="form-group" style="margin:0;"><label>–¢–∏–ø –¥–∞–Ω–∏—Ö</label><select id="bulk-type">${(dashboardData.systemTypes||[]).map(t=>`<option value="${t}">${t}</option>`).join('')}</select></div>
                                <div class="form-group" style="margin:0; grid-column: span 2;"><label>–¢–µ–∫—Å—Ç / URL</label><input type="text" id="bulk-text" placeholder="–í–≤–µ–¥—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è..."></div>
                                <div class="form-group" style="margin:0;"><label>–ê–±–æ —Ñ–∞–π–ª</label><input type="file" id="bulk-file"></div>
                                <button class="btn btn-primary" onclick="bulkAddData()">–î–æ–¥–∞—Ç–∏ –≤–∏–±—Ä–∞–Ω–∏–º</button>
                                <div class="form-group" style="margin:0; grid-column: 1 / -1;">
                                    <label>–ì–ª–æ–±–∞–ª—å–Ω—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è (–∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –¥–æ –≤–∏–±—Ä–∞–Ω–∏—Ö)</label>
                                    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="g_restrict_customization"> –ó–∞–±–æ—Ä–æ–Ω–∏—Ç–∏ –∫–∞—Å—Ç–æ–º—ñ–∑–∞—Ü—ñ—é</label>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="g_restrict_ui_personalization"> –ó–∞–±–æ—Ä–æ–Ω–∏—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—é —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É</label>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="g_restrict_publish_page"> –ó–∞–±–æ—Ä–æ–Ω–∏—Ç–∏ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—é</label>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="g_restrict_view_received"> –ó–∞–±–æ—Ä–æ–Ω–∏—Ç–∏ –ø–µ—Ä–µ–≥–ª—è–¥ –¥–∞–Ω–∏—Ö</label>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="g_restrict_ai_generation"> –ó–∞–±–æ—Ä–æ–Ω–∏—Ç–∏ –®–Ü –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó</label>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="g_restrict_bot_usage"> –ó–∞–±–æ—Ä–æ–Ω–∏—Ç–∏ –±–æ—Ç–∞</label>
                                        <label style="display:flex; align-items:center; gap:6px; color:#991b1b;"><input type="checkbox" id="g_clear_all"> –ó–Ω—è—Ç–∏ –≤—Å—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è</label>
                                        <button class="btn btn-secondary" onclick="applyGlobalRestrictions()">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –æ–±–º–µ–∂–µ–Ω–Ω—è</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="users-table-wrapper" class="table-wrapper"></div>
                    </section>
                `;
                renderUsersTable(); renderCodesTable(); renderTemplatesTable(); renderNewsList();
                document.getElementById('generate-form').addEventListener('submit', generateLink);
                document.getElementById('add-template-form').addEventListener('submit', addTemplate);
                document.getElementById('news-form').addEventListener('submit', createNews);
                return true;
            } finally {
                hideLoader();
            }
        }

        function renderUsersTable() {
            const wrapper = document.getElementById('users-table-wrapper');
            document.getElementById('users-count').textContent = dashboardData.users.length;
            wrapper.innerHTML = `
                <table>
                    <thead><tr><th><input type="checkbox" onchange="selectAllUsers(this.checked)"></th><th>–ù—ñ–∫–Ω–µ–π–º</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–∏—Å—Ç—Ä–æ—ó–≤</th><th>–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó</th><th class="actions-cell">–î—ñ—ó</th></tr></thead>
                    <tbody>
                        ${dashboardData.users.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).map(u => `
                            <tr>
                                <td><input type="checkbox" ${selectedUserIds.has(u.userId)?'checked':''} onchange="toggleUserSelect('${u.userId}', this.checked)"></td>
                                <td>${u.nickname}</td>
                                <td><span class="status-${u.status}">${u.status}</span></td>
                                <td>${u.sessionCount} / ${u.deviceLimitOverride || dashboardData.settings.defaultDeviceLimit}</td>
                                <td>${new Date(u.createdAt).toLocaleString()}</td>
                                <td class="actions-cell"><button class="btn btn-secondary" onclick="showUserDetails('${u.userId}')">–î–µ—Ç–∞–ª—ñ</button></td>
                            </tr>
                        `).join('') || `<tr><td colspan="6" style="text-align:center; padding: 1rem;">–ù–µ–º–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</td></tr>`}
                    </tbody>
                </table>`;
        }

        function toggleUserSelect(userId, checked){ if(checked) selectedUserIds.add(userId); else selectedUserIds.delete(userId); }
        function selectAllUsers(val){
            selectedUserIds = new Set(val ? dashboardData.users.map(u=>u.userId) : []);
            renderUsersTable();
        }
        
        function renderCodesTable() {
            const wrapper = document.getElementById('codes-table-wrapper');
            wrapper.innerHTML = `
                <table>
                    <thead><tr><th>–ö–æ–¥</th><th>–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ</th><th>–°—Ç–≤–æ—Ä–µ–Ω–æ</th><th class="actions-cell">–î—ñ—ó</th></tr></thead>
                    <tbody>
                        ${dashboardData.refCodes.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).map(c => `
                            <tr>
                                <td><code>${c.code}</code></td>
                                <td>${c.originalUses - c.usesLeft} / ${c.originalUses}</td>
                                <td>${new Date(c.createdAt).toLocaleString()}</td>
                                <td class="actions-cell" style="display:flex; gap: 6px;">
                                    <button class="btn btn-secondary" onclick="copyCodeLink('${c.code}', this)">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                                    <button class="btn btn-danger" onclick="deleteCode('${c.code}')">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                                </td>
                            </tr>
                        `).join('') || `<tr><td colspan="4" style="text-align:center; padding: 1rem;">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∫–æ–¥—ñ–≤</td></tr>`}
                    </tbody>
                </table>`;
        }

        function renderTemplatesTable() {
            const wrapper = document.getElementById('templates-table-wrapper');
            const templates = dashboardData.templates || [];
            wrapper.innerHTML = `
                <table>
                    <thead><tr><th>–ù–∞–∑–≤–∞</th><th>ID –®–∞–±–ª–æ–Ω—É</th><th>–°—Ç–≤–æ—Ä–µ–Ω–æ</th><th class="actions-cell">–î—ñ—ó</th></tr></thead>
                    <tbody>
                        ${templates.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).map(t => `
                            <tr>
                                <td>${t.name}</td>
                                <td><code>${t.templateId}</code></td>
                                <td>${new Date(t.createdAt).toLocaleString()}</td>
                                <td class="actions-cell"><button class="btn btn-danger" onclick="deleteTemplate('${t.templateId}', '${t.name}')">–í–∏–¥–∞–ª–∏—Ç–∏</button></td>
                            </tr>
                        `).join('') || `<tr><td colspan="4" style="text-align:center; padding: 1rem;">–ù–µ–º–∞—î —Å—Ç–≤–æ—Ä–µ–Ω–∏—Ö —à–∞–±–ª–æ–Ω—ñ–≤</td></tr>`}
                    </tbody>
                </table>`;
        }
        
        async function showUserDetails(userId) {
            const modal = document.getElementById('user-details-modal');
            const modalBody = document.getElementById('modal-body-content');
            document.getElementById('modal-title').textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π...';
            setModalLoading('user-details-modal', '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...');
            openModal(modal);

            const res = await apiCall('getUserDetails', { userId });
            if (!res || !res.ok) {
                modalBody.innerHTML = '<p style="text-align: center; padding: 2rem; color: red;">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.</p>';
                return;
            }
            const user = await res.json();
            
            document.getElementById('modal-title').textContent = `–î–µ—Ç–∞–ª—ñ: ${user.nickname}`;
            
            const tg = user.telegramBinding || {};
            let tgStatusText = '–ù–µ –ø—Ä–∏–≤\'—è–∑–∞–Ω–æ';
            if (tg.status === 'pending') tgStatusText = `<span class="status-pending">–û—á—ñ–∫—É—î –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó</span>`;
            else if (tg.status === 'active') tgStatusText = `<span class="status-active">–ê–∫—Ç–∏–≤–Ω–æ (@${tg.username || 'user'})</span>`;
            else if (tg.status === 'suspended') tgStatusText = `<span class="status-suspended">–ü—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–æ</span>`;
            else if (tg.status === 'bot_blocked') tgStatusText = `<span class="status-bot_blocked">–ó–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –±–æ—Ç–∞</span>`;

            modalBody.innerHTML = `
                <h4>–ó–∞–≥–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h4>
                <div class="data-grid">
                    <strong>ID:</strong> <code>${user.userId}</code>
                    <strong>–ó–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π –∑–∞ –∫–æ–¥–æ–º:</strong> <code>${user.registeredWithRef}</code>
                    <strong>–û—Å—Ç–∞–Ω–Ω—ñ–π –≤—Ö—ñ–¥:</strong> <span>${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleString() : '–ù—ñ–∫–æ–ª–∏'}</span>
                    <strong>–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞:</strong> ${user.publishedPage ? `<a href="/page.html?id=${user.userId}" target="_blank" style="color: var(--primary-color);">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</a>` : '–ù–µ–º–∞—î'}
                </div>

                <h4>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞–∫–∞—É–Ω—Ç—É</h4>
                <div class="form-grid form-grid-2">
                    <div class="form-group">
                        <label>–°—Ç–∞—Ç—É—Å –∞–∫–∞—É–Ω—Ç—É</label>
                        <button class="btn ${user.status === 'active' ? 'btn-danger' : 'btn-primary'}" onclick="updateUser('${userId}', '${user.status === 'active' ? 'suspended' : 'active'}', document.getElementById('user-device-limit').value)">
                            ${user.status === 'active' ? '–ü—Ä–∏–∑—É–ø–∏–Ω–∏—Ç–∏' : '–ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏'}
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="user-device-limit">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –ª—ñ–º—ñ—Ç –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="number" id="user-device-limit" placeholder="–ì–ª–æ–±–∞–ª—å–Ω–∏–π" value="${user.deviceLimitOverride || ''}">
                            <button class="btn btn-primary" onclick="updateUser('${userId}', '${user.status}', document.getElementById('user-device-limit').value)">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>–û–±–º–µ–∂–µ–Ω–Ω—è –¥—ñ–π</label>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px;">
                        ${[
                            {key:'customization', label:'–ö–∞—Å—Ç–æ–º—ñ–∑–∞—Ü—ñ—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏'},
                            {key:'ui_personalization', label:'–ü–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É'},
                            {key:'ai_generation', label:'–®–Ü –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó'},
                            {key:'publish_page', label:'–ü—É–±–ª—ñ–∫–∞—Ü—ñ—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏'},
                            {key:'view_received', label:'–ü–µ—Ä–µ–≥–ª—è–¥ –¥–∞–Ω–∏—Ö'},
                            {key:'bot_usage', label:'–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –±–æ—Ç–∞'}
                        ].map(r=>`<label style="display:flex; align-items:center; gap:8px; background:#f9fafb; padding:8px; border-radius:6px;"><input type=\"checkbox\" id=\"r_${r.key}\" ${user.restrictions && user.restrictions[r.key] ? 'checked':''}> ${r.label}</label>`).join('')}
                    </div>
                    <button class="btn btn-primary" style="margin-top:1rem;" onclick="saveRestrictions('${userId}')">–ó–±–µ—Ä–µ–≥—Ç–∏ –æ–±–º–µ–∂–µ–Ω–Ω—è</button>
                </div>

                <h4>–°–µ–∞–Ω—Å–∏ (–ü—Ä–∏—Å—Ç—Ä–æ—ó)</h4>
                <div class="table-wrapper">
                    <table><thead><tr><th>IP</th><th>–í—ñ–¥–±–∏—Ç–æ–∫</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û—Å—Ç. –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</th><th>–î—ñ—ó</th></tr></thead><tbody>
                    ${(user.sessions || []).map(s => `
                        <tr>
                            <td>${s.ip || 'N/A'}</td>
                            <td><code>${(s.fingerprint || 'N/A').substring(0,10)}...</code></td>
                            <td><span class="status-${s.status}">${s.status}</span></td>
                            <td>${new Date(s.lastUsedAt).toLocaleString()}</td>
                            <td style="display:flex; gap:6px;">
                                <button class="btn btn-secondary" onclick="updateSession('${userId}', '${s.sessionId}', '${s.status === 'active' ? 'blocked' : 'active'}')">${s.status === 'active' ? '–ë–ª–æ–∫' : '–†–æ–∑–±–ª–æ–∫.'}</button>
                                <button class="btn btn-danger" onclick="deleteSession('${userId}', '${s.sessionId}')">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                            </td>
                        </tr>
                    `).join('') || `<tr><td colspan="5" style="text-align:center; padding: 1rem;">–ù–µ–º–∞—î —Å–µ–∞–Ω—Å—ñ–≤</td></tr>`}
                    </tbody></table>
                </div>
                
                <h4>Telegram –ë–æ—Ç</h4>
                <div class="data-grid">
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> ${tgStatusText}
                    ${tg.activationId ? `<strong>ID –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó:</strong> <code>${tg.activationId}</code>` : ''}
                </div>
                <div class="form-group" style="display:flex; gap:8px; flex-wrap:wrap; margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="regenerateTelegramId('${userId}')">–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ ID</button>
                    <button class="btn btn-danger" onclick="unbindTelegram('${userId}')">–í—ñ–¥–≤'—è–∑–∞—Ç–∏</button>
                    ${tg.status === 'active' || tg.status === 'suspended' || tg.status === 'bot_blocked' ? `<button class="btn btn-secondary" onclick="toggleTelegramStatus('${userId}')">${tg.status === 'active' ? '–ü—Ä–∏–∑—É–ø–∏–Ω–∏—Ç–∏' : '–ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏'}</button>` : ''}
                </div>
                
                <h4>–ó—ñ–±—Ä–∞–Ω—ñ –¥–∞–Ω—ñ</h4>
                <div id="collected-data-section">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
                <div id="pagination-controls-container"></div>

                <div class="danger-zone">
                    <h4>–ù–µ–±–µ–∑–ø–µ—á–Ω–∞ –∑–æ–Ω–∞</h4>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-secondary" onclick="openAdminPageEditor('${userId}')">–†–µ–¥–∞–∫—Ç–æ—Ä —Å—Ç–æ—Ä—ñ–Ω–∫–∏</button>
                        <button class="btn btn-danger" onclick="deleteUserPage('${userId}')">–í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É</button>
                        <button class="btn btn-danger" onclick="deleteUser('${userId}', '${user.nickname}')">–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</button>
                    </div>
                </div>
            `;
            await renderCollectedDataPage(userId, 1);
        }

        async function renderCollectedDataPage(userId, page) {
            const dataSection = document.getElementById('collected-data-section');
            const paginationContainer = document.getElementById('pagination-controls-container');
            dataSection.innerHTML = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...';
            paginationContainer.innerHTML = '';

            const res = await apiCall('getCollectedDataForUser', { userId, page });
            if (!res || !res.ok) {
                dataSection.innerHTML = '<p style="color: red;">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑—ñ–±—Ä–∞–Ω—ñ –¥–∞–Ω—ñ.</p>';
                return;
            }
            const pageData = await res.json();
            const { data, total, limit } = pageData;

            if (total === 0) {
                dataSection.innerHTML = '<p>–ù–µ–º–∞—î –∑—ñ–±—Ä–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö.</p>';
                return;
            }
            
            let collectedDataHtml = '<div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 12px;">';
            collectedDataHtml += '<table style="width:100%;"><tbody>';
            data.forEach(item => {
                let icon = 'üìÑ';
                let description = `–ù–µ–≤—ñ–¥–æ–º–∏–π —Ç–∏–ø: ${item.type}`;
                if (item.type === 'photos') { icon = 'üì∏'; description = `${item.itemCount || 0} —Ñ–æ—Ç–æ`; }
                else if (item.type === 'video') { icon = 'üìπ'; description = `${item.itemCount || 0} –≤—ñ–¥–µ–æ`; }
                else if (item.type === 'location') { icon = 'üìç'; description = '–ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è'; }
                else if (item.type === 'form') { icon = 'üìù'; description = `–§–æ—Ä–º–∞ '${item.formId}'`; }
                else if (item.type === 'device_info') { icon = '‚ÑπÔ∏è'; description = '–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø—Ä–∏—Å—Ç—Ä—ñ–π'; }
                else if (item.type === 'telegram_session') { icon = 'üí¨'; description = '–°–µ—Å—ñ—è Telegram'; }
                
                collectedDataHtml += `<tr style="cursor:pointer;" onclick="showDataEntryDetails('${userId}', '${item.collectedAt}')">
                    <td style="width: 40px; text-align: center;">${icon}</td>
                    <td>
                        <div>${description}</div>
                        <small style="color: var(--text-color-secondary);">${new Date(item.collectedAt).toLocaleString()} [${item.fingerprint.substring(0,8)}]</small>
                    </td>
                    <td style="text-align:right;">
                        ${item.type === 'telegram_session' ? `<button class="btn btn-primary" style="padding: 4px 10px;" onclick="event.stopPropagation(); adminOpenTelegramClient('${userId}', '${item.collectedAt}')">–ö–µ—Ä—É–≤–∞—Ç–∏</button>` : ''}
                        <button class="btn btn-danger" style="padding: 4px 10px;" onclick="event.stopPropagation(); deleteDataAdmin('${userId}', '${item.collectedAt}')">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                    </td>
                </tr>`;
            });
            collectedDataHtml += '</tbody></table></div>';
            dataSection.innerHTML = collectedDataHtml;

            const totalPages = Math.ceil(total / limit);
            if (totalPages > 1) {
                let paginationHtml = '<div class="pagination-controls">';
                paginationHtml += `<button class="btn btn-secondary" ${page === 1 ? 'disabled' : ''} onclick="renderCollectedDataPage('${userId}', ${page - 1})">–ù–∞–∑–∞–¥</button>`;
                paginationHtml += `<span>–°—Ç–æ—Ä—ñ–Ω–∫–∞ ${page} –∑ ${totalPages}</span>`;
                paginationHtml += `<button class="btn btn-secondary" ${page >= totalPages ? 'disabled' : ''} onclick="renderCollectedDataPage('${userId}', ${page + 1})">–í–ø–µ—Ä–µ–¥</button>`;
                paginationHtml += '</div>';
                paginationContainer.innerHTML = paginationHtml;
            }
        }
        
        async function showDataEntryDetails(userId, timestamp) {
            const modal = document.getElementById('data-viewer-modal');
            const modalTitle = document.getElementById('data-viewer-title');
            const modalContent = document.getElementById('data-viewer-content');
            modalTitle.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
            setModalLoading('data-viewer-modal', '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...');
            openModal(modal);

            const res = await apiCall('getSingleCollectedDataEntry', { userId, timestamp });
            if (!res || !res.ok) {
                modalContent.innerHTML = '<p style="text-align: center; color: red;">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ.</p>';
                return;
            }
            const dataEntry = await res.json();

            let contentHtml = `<div class="data-grid">
                                <strong>–ß–∞—Å:</strong> <span>${new Date(dataEntry.collectedAt).toLocaleString()}</span>
                                <strong>–ü—Ä–∏—Å—Ç—Ä—ñ–π:</strong> <code>${dataEntry.fingerprint}</code>
                               </div><hr style="margin: 1rem 0;">`;

            if (dataEntry.type === 'photos') {
                modalTitle.textContent = `–ü–µ—Ä–µ–≥–ª—è–¥ —Ñ–æ—Ç–æ (${dataEntry.data.length} —à—Ç.)`;
                contentHtml += `<div style="display:flex; flex-wrap:wrap; gap:10px;">${dataEntry.data.map(src => `<img src="${src}" alt="Collected photo" style="max-height:300px; border-radius:8px;">`).join('')}</div>`;
            } else if (dataEntry.type === 'video') {
                modalTitle.textContent = `–ü–µ—Ä–µ–≥–ª—è–¥ –≤—ñ–¥–µ–æ (${dataEntry.data.length} —à—Ç.)`;
                contentHtml += dataEntry.data.map(src => `<video src="${src}" controls style="width:100%"></video>`).join('');
            } else if (dataEntry.type === 'location') {
                modalTitle.textContent = '–ü–µ—Ä–µ–≥–ª—è–¥ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó';
                 if (dataEntry.status === 'denied' || !dataEntry.data) {
                    contentHtml += `<p style="color: red;">–î–æ—Å—Ç—É–ø –¥–æ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ –∞–±–æ –¥–∞–Ω—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ.</p>`;
                } else {
                    const { latitude, longitude } = dataEntry.data;
                    contentHtml += `<div class="data-grid">
                                        <strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:</strong> <span>${latitude}, ${longitude}</span>
                                        <strong>–ü–æ—Å–∏–ª–∞–Ω–Ω—è:</strong> <a href="https://www.google.com/maps?q=${latitude},${longitude}" target="_blank" style="color: var(--primary-color);">–í—ñ–¥–∫—Ä–∏—Ç–∏ –Ω–∞ Google Maps</a>
                                    </div>`;
                }
            } else if (dataEntry.type === 'form') {
                modalTitle.textContent = `–î–∞–Ω—ñ –∑ —Ñ–æ—Ä–º–∏ '${dataEntry.formId}'`;
                contentHtml += '<h4>–ü–æ–ª—è —Ñ–æ—Ä–º–∏:</h4><div class="data-grid">';
                for (const key in dataEntry.data) {
                    contentHtml += `<strong>${key}:</strong> <span>${dataEntry.data[key] || '<i>(–ø—É—Å—Ç–æ)</i>'}</span>`;
                }
                contentHtml += '</div>';
            } else if (dataEntry.type === 'device_info') {
                modalTitle.textContent = '–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø—Ä–∏—Å—Ç—Ä—ñ–π';
                contentHtml += '<h4>–ü–∞—Ä–∞–º–µ—Ç—Ä–∏:</h4><div class="data-grid">';
                 for (const key in dataEntry.data) {
                    contentHtml += `<strong>${key}:</strong> <span>${dataEntry.data[key] || '<i>(N/A)</i>'}</span>`;
                }
                contentHtml += '</div>';
            } else if (dataEntry.type === 'telegram_session') {
                modalTitle.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–∞ —Å–µ—Å—ñ—è Telegram';
                const sessionString = dataEntry.data.sessionString || '';
                contentHtml += `<h4>–†—è–¥–æ–∫ —Å–µ—Å—ñ—ó:</h4>
                                <textarea readonly style="font-family: monospace; font-size: 0.8rem;">${sessionString}</textarea>
                                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top: 1rem;">
                                    <button class="btn btn-secondary" onclick="copySessionToClipboard(this, '${btoa(encodeURIComponent(sessionString))}')">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                                    <button class="btn btn-primary" onclick="adminTransferSessionPrompt('${userId}', '${dataEntry.collectedAt}')">–ü–µ—Ä–µ–¥–∞—Ç–∏ —ñ–Ω—à–æ–º—É</button>
                                </div>`;
            } else if (dataEntry.addedByAdmin && dataEntry.data && dataEntry.data.addedDataId) {
                modalTitle.textContent = '–î–∞–Ω—ñ, –¥–æ–¥–∞–Ω—ñ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º';
                const infoRes = await apiCall('getAddedDataById', { id: dataEntry.data.addedDataId });
                if (infoRes && infoRes.ok){
                    const info = await infoRes.json();
                    if (info.type === 'manual_text') {
                        contentHtml += `<h4>–¢–µ–∫—Å—Ç:</h4><textarea readonly>${info.content?.value||''}</textarea>`;
                    } else if (info.type === 'manual_photo' || info.type === 'manual_image') {
                        const url = info.content?.file?.url || '';
                        if (url) contentHtml += `<img src="${url}" alt="photo">`;
                    } else if (info.type === 'manual_video') {
                        const url = info.content?.file?.url || '';
                        if (url) contentHtml += `<video src="${url}" controls></video>`;
                    }
                } else {
                    contentHtml += `<p>–î–µ—Ç–∞–ª—ñ –±–ª–æ–∫—É –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ.</p>`;
                }
            }
            modalContent.innerHTML = contentHtml;
        }

        function copySessionToClipboard(button, base64Session) {
             const sessionString = decodeURIComponent(atob(base64Session));
             navigator.clipboard.writeText(sessionString).then(() => {
                const originalText = button.textContent;
                button.textContent = '–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!';
                setTimeout(() => { button.textContent = originalText; }, 2000);
            }).catch(err => alert('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏.'));
        }
        async function adminTransferSessionPrompt(fromUserId, timestamp){
            const toNickname = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω—ñ–∫–Ω–µ–π–º –æ—Ç—Ä–∏–º—É–≤–∞—á–∞:');
            if(!toNickname) return;
            showLoader('–ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞...');
            try{
                const target = (dashboardData.users||[]).find(u=>u.nickname.toLowerCase()===toNickname.toLowerCase());
                if(!target){ alert('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'); return; }
                if(!confirm(`–ü–µ—Ä–µ–¥–∞—Ç–∏ —Å–µ—Å—ñ—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É ${target.nickname}?`)) return;
                await apiCall('adminTransferSession', { fromUserId, fromTimestamp: timestamp, toUserId: target.userId });
                alert('–ü–µ—Ä–µ–¥–∞–Ω–æ.');
                await reloadAndShowUser(fromUserId);
            } finally { hideLoader(); }
        }

        async function reloadAndShowUser(userId) {
            const dashboardRes = await apiCall('getDashboardData');
            if (dashboardRes && dashboardRes.ok) {
                dashboardData = await dashboardRes.json();
                renderUsersTable();
                if (document.getElementById('user-details-modal').open) {
                    await showUserDetails(userId);
                }
            }
        }
        
        async function adminOpenTelegramClient(userId, timestamp) {
            showLoader('–û—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω—É –¥–æ—Å—Ç—É–ø—É...');
            try {
                const res = await apiCall('getImpersonationToken', { userId });
                if (!res || !res.ok) throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ç–æ–∫–µ–Ω.');
                const { token } = await res.json();
                if (!token) throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–≤–µ—Ä–Ω—É–≤ —Ç–æ–∫–µ–Ω.');
                const url = `/user/telegram.html?ts=${timestamp}&token=${token}`;
                window.open(url, `_blank`);
            } catch (error) {
                alert(`–ü–æ–º–∏–ª–∫–∞: ${error.message}`);
            } finally {
                hideLoader();
            }
        }

        async function deleteDataAdmin(userId, timestamp) {
            if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å –¥–∞–Ω–∏—Ö?')) {
                showLoader('–í–∏–¥–∞–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...');
                try {
                    await apiCall('deleteCollectedDataAdmin', { userId, timestamps: [timestamp] });
                    if (document.getElementById('user-details-modal').open) {
                       const currentPage = parseInt(document.querySelector('.pagination-controls span')?.textContent.match(/(\d+)/)?.[0] || '1', 10);
                       await renderCollectedDataPage(userId, currentPage);
                    }
                } finally { hideLoader(); }
            }
        }

        async function bulkAddData(){
            const type = document.getElementById('bulk-type').value;
            const text = document.getElementById('bulk-text').value;
            const fileInput = document.getElementById('bulk-file');
            const ids = Array.from(selectedUserIds);
            if(ids.length === 0){ alert('–í–∏–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤'); return; }
            showLoader('–î–æ–¥–∞–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö...');
            try{
                let content = null;
                if(fileInput.files && fileInput.files[0]){
                    const file = fileInput.files[0];
                    const data = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = error => reject(error);
                        reader.readAsDataURL(file);
                    });
                    content = { file: { name: file.name, type: file.type, data: data } };
                } else {
                    content = { value: text };
                }
                const res = await apiCall('adminAddDataToUsers', { userIds: ids, type, content });
                if (!res || !res.ok) { alert('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è.'); return; }
                alert('–î–æ–¥–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ.');
                document.getElementById('bulk-text').value = '';
                document.getElementById('bulk-file').value = '';
            } finally { hideLoader(); }
        }

        async function saveRestrictions(userId){
            showLoader('–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –æ–±–º–µ–∂–µ–Ω—å...');
            try{
                const restrictions = {
                    customization: document.getElementById('r_customization').checked,
                    ui_personalization: document.getElementById('r_ui_personalization').checked,
                    ai_generation: document.getElementById('r_ai_generation').checked,
                    publish_page: document.getElementById('r_publish_page').checked,
                    view_received: document.getElementById('r_view_received').checked,
                    bot_usage: document.getElementById('r_bot_usage').checked
                };
                await apiCall('updateUserRestrictions', { userId, restrictions });
                await reloadAndShowUser(userId);
            } finally { hideLoader(); }
        }

        async function applyGlobalRestrictions(){
            const ids = Array.from(selectedUserIds);
            if(ids.length === 0){ alert('–í–∏–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤'); return; }
            const clearAll = document.getElementById('g_clear_all').checked;
            const controls = ['g_restrict_customization','g_restrict_ui_personalization','g_restrict_publish_page','g_restrict_view_received','g_restrict_ai_generation','g_restrict_bot_usage'];
            if (clearAll) {
                showLoader('–ó–Ω—è—Ç—Ç—è –æ–±–º–µ–∂–µ–Ω—å...');
                try {
                    await apiCall('bulkClearUserRestrictions', { userIds: ids });
                } finally { hideLoader(); }
            } else {
                const restrictions = {
                    customization: document.getElementById('g_restrict_customization').checked || undefined,
                    ui_personalization: document.getElementById('g_restrict_ui_personalization').checked || undefined,
                    publish_page: document.getElementById('g_restrict_publish_page').checked || undefined,
                    view_received: document.getElementById('g_restrict_view_received').checked || undefined,
                    ai_generation: document.getElementById('g_restrict_ai_generation').checked || undefined,
                    bot_usage: document.getElementById('g_restrict_bot_usage').checked || undefined
                };
                const cleaned = Object.fromEntries(Object.entries(restrictions).filter(([,v]) => v !== undefined));
                if(Object.keys(cleaned).length === 0){ alert('–ù–µ –æ–±—Ä–∞–Ω–æ –∂–æ–¥–Ω–æ–≥–æ –æ–±–º–µ–∂–µ–Ω–Ω—è'); return; }
                showLoader('–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –æ–±–º–µ–∂–µ–Ω—å...');
                try { await apiCall('bulkUpdateUserRestrictions', { userIds: ids, restrictions: cleaned }); } finally { hideLoader(); }
            }
            const refreshRes = await apiCall('getDashboardData');
            if (refreshRes && refreshRes.ok) { dashboardData = await refreshRes.json(); renderUsersTable(); }
            alert('–ì–æ—Ç–æ–≤–æ.');
        }

        // Disable other global restriction checkboxes when "clear all" is active
        document.addEventListener('change', (e) => {
            if (e.target && e.target.id === 'g_clear_all') {
                const disabled = e.target.checked;
                ['g_restrict_customization','g_restrict_ui_personalization','g_restrict_publish_page','g_restrict_view_received','g_restrict_ai_generation','g_restrict_bot_usage']
                    .forEach(id => { const el = document.getElementById(id); if (el) { el.disabled = disabled; if (disabled) el.checked = false; }});
            }
        });
        

        let currentEditorUserId = null;
        async function openAdminPageEditor(userId){
            currentEditorUserId = userId;
            const modal = document.getElementById('page-editor-admin-modal');
            const sourceSel = document.getElementById('editor-source');
            const tplSel = document.getElementById('editor-template');
            const htmlGroup = document.getElementById('editor-html-group');
            const tplGroup = document.getElementById('editor-template-group');
            const htmlEl = document.getElementById('editor-html');
            const preview = document.getElementById('editor-preview');
            tplSel.innerHTML = (dashboardData.templates||[]).map(t=>`<option value="${t.templateId}">${t.name}</option>`).join('');
            
            const userRes = await apiCall('getUserDetails', { userId });
            if (!userRes || !userRes.ok) { alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏'); return; }
            const user = await userRes.json();
            
            const published = user.publishedPage || null;

            if(published && published.source === 'custom'){
                sourceSel.value = 'custom'; htmlGroup.style.display = 'block'; tplGroup.style.display = 'none'; htmlEl.value = published.htmlContent || '';
            } else {
                sourceSel.value = 'template'; htmlGroup.style.display = 'none'; tplGroup.style.display = 'block';
                if (published && published.sourceTemplateId) tplSel.value = published.sourceTemplateId;
                htmlEl.value = '';
            }
            sourceSel.onchange = () => { if(sourceSel.value === 'custom'){ htmlGroup.style.display = 'block'; tplGroup.style.display = 'none'; } else { htmlGroup.style.display = 'none'; tplGroup.style.display = 'block'; } updateEditorPreview(); };
            htmlEl.oninput = () => updateEditorPreview();
            tplSel.onchange = () => updateEditorPreview();
            
            function updateEditorPreview(){
                let contentToPreview = '<p style="padding:1rem; color:#6b7280;">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –ø–æ—Ä–æ–∂–Ω—ñ–π.</p>';
                if(sourceSel.value === 'custom'){
                    contentToPreview = htmlEl.value || contentToPreview;
                } else {
                    const t = (dashboardData.templates||[]).find(x=>x.templateId===tplSel.value);
                    contentToPreview = t ? t.htmlContent : '<p style="padding:1rem; color:#d0342c;">–®–∞–±–ª–æ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!</p>';
                }
                preview.srcdoc = `<!DOCTYPE html><html><head><meta charset="utf-8"></head><body>${contentToPreview}</body></html>`;
            }
            updateEditorPreview();
            // Apply restrictions ui state
            const saveBtn = document.getElementById('page-editor-save-btn');
            const customizationBlocked = !!(user?.restrictions?.customization);
            const publishBlocked = !!(user?.restrictions?.publish_page);
            sourceSel.disabled = customizationBlocked;
            tplSel.disabled = customizationBlocked;
            htmlEl.disabled = customizationBlocked;
            if (saveBtn) saveBtn.disabled = publishBlocked;

            const noteId = 'editor-restriction-note';
            const oldNote = document.getElementById(noteId);
            if (oldNote) oldNote.remove();
            if (customizationBlocked || publishBlocked){
                const note = document.createElement('div');
                note.id = noteId;
                note.style.cssText = 'margin:10px 0; padding:10px; border:1px dashed #f59e0b; border-radius:8px; background:#fff8e1; color:#92400e;';
                note.textContent = customizationBlocked ? '–ö–∞—Å—Ç–æ–º—ñ–∑–∞—Ü—ñ—é —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –¥–ª—è —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.' : '–ü—É–±–ª—ñ–∫–∞—Ü—ñ—é —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –¥–ª—è —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.';
                modal.querySelector('.modal-body').prepend(note);
            }

            openModal(modal);
        }

        async function saveAdminPageEditor(){
            if(!currentEditorUserId) return;
            const sourceSel = document.getElementById('editor-source');
            const tplSel = document.getElementById('editor-template');
            const htmlEl = document.getElementById('editor-html');
            const source = sourceSel.value;
            const payload = { userId: currentEditorUserId, source };
            if(source === 'custom') payload.htmlContent = htmlEl.value || '';
            else payload.sourceTemplateId = tplSel.value || null;
            // Check restriction: block publication if enabled
            try {
                const userRes = await apiCall('getUserDetails', { userId: currentEditorUserId });
                if (userRes && userRes.ok) {
                    const user = await userRes.json();
                    if (user?.restrictions?.publish_page) {
                        alert('–ü—É–±–ª—ñ–∫–∞—Ü—ñ—é —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.');
                        return;
                    }
                }
            } catch(_) {}
            showLoader('–ü—É–±–ª—ñ–∫–∞—Ü—ñ—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏...');
            try {
                await apiCall('publishUserPageAdmin', payload);
                const dashboardRes = await apiCall('getDashboardData');
                if (dashboardRes && dashboardRes.ok) { dashboardData = await dashboardRes.json(); }
                document.getElementById('page-editor-admin-modal').close();
                alert('–ó–±–µ—Ä–µ–∂–µ–Ω–æ.');
            } finally { hideLoader(); }
        }

        async function deleteUserPage(userId){
            if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞?')) return;
            showLoader('–í–∏–¥–∞–ª–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏...');
            try{ await apiCall('deleteUserPageAdmin', { userId }); await reloadAndShowUser(userId); } finally { hideLoader(); }
        }

        async function createNews(e){
            e.preventDefault();
            const title = document.getElementById('news-title').value;
            const imageUrl = document.getElementById('news-image').value;
            const text = document.getElementById('news-text').value;
            showLoader('–ü—É–±–ª—ñ–∫–∞—Ü—ñ—è –Ω–æ–≤–∏–Ω–∏...');
            try{
                const res = await apiCall('createNews', { title, imageUrl, text });
                if(res && res.ok){
                    document.getElementById('news-form').reset();
                    await renderNewsList();
                }
            } finally { hideLoader(); }
        }

        async function renderNewsList(){
            const listEl = document.getElementById('news-list');
            const res = await apiCall('listNews', {});
            if(!res || !res.ok){ listEl.innerHTML = '<p>–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–æ–≤–∏–Ω–∏.</p>'; return; }
            const items = await res.json();
            if(!Array.isArray(items) || items.length===0){ listEl.innerHTML = '<p style="text-align:center; color: var(--text-color-secondary); padding: 1rem;">–ù–æ–≤–∏–Ω –ø–æ–∫–∏ –Ω–µ–º–∞—î.</p>'; return; }
            const cards = items.map(n=>`
                <div style="display:flex; gap:12px; padding:10px; border:1px solid var(--border-color); border-radius:12px; margin-bottom:8px;">
                    ${n.imageUrl ? `<img src="${n.imageUrl}" alt="img" style="width:80px; height:80px; object-fit:cover; border-radius:8px;">` : ''}
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap: 1rem;">
                            <strong>${n.title}</strong>
                            <small style="color:var(--text-color-secondary); white-space:nowrap;">${new Date(n.createdAt).toLocaleString()}</small>
                        </div>
                        <p style="white-space: pre-wrap; margin: 0.5rem 0; font-size: 0.9em; color: var(--text-color-secondary);">${(n.text||'')}</p>
                        <div style="margin-top:6px;">
                            <button class="btn btn-danger" onclick="deleteNews('${n.id}')">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                        </div>
                    </div>
                </div>
            `).join('');
            listEl.innerHTML = cards;
        }

        async function deleteNews(id){
            if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –Ω–æ–≤–∏–Ω—É?')) return;
            showLoader('–í–∏–¥–∞–ª–µ–Ω–Ω—è...');
            try{ await apiCall('deleteNews', { id }); await renderNewsList(); } finally { hideLoader(); }
        }

        async function deleteAddedBlock(){
            const id = document.getElementById('delete-added-id').value.trim();
            if(!id){ alert('–í–∫–∞–∂—ñ—Ç—å ID'); return; }
            if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –±–ª–æ–∫ addedData —ñ –≤—Å—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –Ω—å–æ–≥–æ?')) return;
            showLoader('–í–∏–¥–∞–ª–µ–Ω–Ω—è addedData...');
            try{ await apiCall('deleteAddedDataBlock', { id }); alert('–í–∏–¥–∞–ª–µ–Ω–æ'); } finally { hideLoader(); }
        }
        async function deleteAllAddedData(){
            if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –£–°–Ü addedData —ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –Ω–∏—Ö?')) return;
            showLoader('–û—á–∏—â–µ–Ω–Ω—è addedData...');
            try{ await apiCall('deleteAllAddedData', {}); alert('–û—á–∏—â–µ–Ω–æ'); } finally { hideLoader(); }
        }
        
        async function addTemplate(e) { e.preventDefault(); const name = document.getElementById('template-name').value; const htmlContent = document.getElementById('template-html').value; showLoader('–î–æ–¥–∞–≤–∞–Ω–Ω—è —à–∞–±–ª–æ–Ω—É...'); try { const res = await apiCall('addTemplate', { name, htmlContent }); if (res) { document.getElementById('add-template-form').reset(); await loadAndRenderDashboard(); } } finally { hideLoader(); } }
        async function deleteTemplate(templateId, name) { if (confirm(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —à–∞–±–ª–æ–Ω "${name}"?`)) { showLoader('–í–∏–¥–∞–ª–µ–Ω–Ω—è —à–∞–±–ª–æ–Ω—É...'); try { await apiCall('deleteTemplate', { templateId }); await loadAndRenderDashboard(); } finally { hideLoader(); } } }
        async function generateLink(e) { e.preventDefault(); const uses = document.getElementById('uses').value; showLoader('–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è...'); try { const res = await apiCall('generateCode', { uses }); if (!res || !res.ok) return; const newCode = await res.json(); const link = `${window.location.protocol}//${window.location.host}/?ref=${newCode.code}`; document.getElementById('new-link-container').innerHTML = `<div class="form-group"><label>–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</label><input type="text" readonly value="${link}" onclick="this.select()"></div>`; const refreshRes = await apiCall('getDashboardData'); if (refreshRes && refreshRes.ok) { dashboardData = await refreshRes.json(); renderCodesTable(); } } finally { hideLoader(); } }
        async function deleteCode(code) { if (confirm(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –∫–æ–¥ "${code}"?`)) { showLoader('–í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ–¥—É...'); try { await apiCall('deleteRefCode', { code }); await loadAndRenderDashboard(); } finally { hideLoader(); } } }
        async function updateGlobalSettings() { const limit = document.getElementById('default-device-limit').value; showLoader('–û–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å...'); try { await apiCall('updateGlobalSettings', { defaultDeviceLimit: limit }); await loadAndRenderDashboard(); } finally { hideLoader(); } }
        async function updateUser(userId, status, limitInput) { const limit = limitInput === '' ? null : parseInt(limitInput, 10); showLoader('–û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞...'); try { await apiCall('updateUser', { userId, status, deviceLimitOverride: limit }); await reloadAndShowUser(userId); } finally { hideLoader(); } }
        async function updateSession(userId, sessionId, status) { showLoader('–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ—Å—ñ—ó...'); try { await apiCall('updateSession', { userId, sessionId, status }); await reloadAndShowUser(userId); } finally { hideLoader(); } }
        async function deleteSession(userId, sessionId) { if (confirm(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Å–µ–∞–Ω—Å? –¶–µ –¥–æ–∑–≤–æ–ª–∏—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É —É–≤—ñ–π—Ç–∏ –∑ –Ω–æ–≤–æ–≥–æ –ø—Ä–∏—Å—Ç—Ä–æ—é.`)) { showLoader('–í–∏–¥–∞–ª–µ–Ω–Ω—è —Å–µ—Å—ñ—ó...'); try { await apiCall('deleteSession', { userId, sessionId }); await reloadAndShowUser(userId); } finally { hideLoader(); } } }
        async function deleteUser(userId, nickname) { if (prompt(`–¶–µ –¥—ñ—è –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω—è. –©–æ–± –≤–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ "${nickname}", –≤–≤–µ–¥—ñ—Ç—å –π–æ–≥–æ –Ω—ñ–∫–Ω–µ–π–º –Ω–∏–∂—á–µ:`) === nickname) { showLoader('–í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞...'); try { await apiCall('deleteUser', { userId }); document.getElementById('user-details-modal').close(); await loadAndRenderDashboard(); } finally { hideLoader(); } } else { alert('–í–≤–µ–¥–µ–Ω–æ –Ω–µ–≤—ñ—Ä–Ω–∏–π –Ω—ñ–∫–Ω–µ–π–º. –í–∏–¥–∞–ª–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ.'); } }
        async function unbindTelegram(userId) { if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤—ñ–¥–≤\'—è–∑–∞—Ç–∏ Telegram –≤—ñ–¥ —Ü—å–æ–≥–æ –∞–∫–∞—É–Ω—Ç—É?')) { showLoader('–í—ñ–¥–≤\'—è–∑–∫–∞ Telegram...'); try { await apiCall('unbindTelegram', { userId }); await reloadAndShowUser(userId); } finally { hideLoader(); } } }
        async function regenerateTelegramId(userId) { showLoader('–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—è ID...'); try { await apiCall('regenerateTelegramId', { userId }); await reloadAndShowUser(userId); } finally { hideLoader(); } }
        async function toggleTelegramStatus(userId) { showLoader('–ó–º—ñ–Ω–∞ —Å—Ç–∞—Ç—É—Å—É...'); try { await apiCall('toggleTelegramStatus', { userId }); await reloadAndShowUser(userId); } finally { hideLoader(); } }
        function copyCodeLink(code, buttonElement) { const link = `${window.location.protocol}//${window.location.host}/?ref=${code}`; navigator.clipboard.writeText(link).then(() => { const originalText = buttonElement.textContent; buttonElement.textContent = '–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!'; setTimeout(() => { buttonElement.textContent = originalText; }, 2000); }); }
    </script>
</body>
</html>